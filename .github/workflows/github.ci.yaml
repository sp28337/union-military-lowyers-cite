name: Deploy SPA to Timeweb

on:
  push:
    branches:
      - main
      - dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Скачиваем код из репозитория
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Устанавливаем pnpm
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.10.0

      # 3. Устанавливаем Node.js 22.16.0
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.16.0'
          cache: 'pnpm'

      # 4. Устанавливаем зависимости
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # 5. Собираем проект
      - name: Build project
        run: pnpm build

      # 6. Загружаем dist на сервер
      - name: Upload dist to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          port: ${{ secrets.PORT }}
          username: sp28337
          key: ${{ secrets.SSH_PRIVATE_KEY}}
          source: "dist/*"
          target: "/home/sp28337/spa_build/"
          rm: true

      # 7. Выполняем команды на сервере
      - name: Deploy on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          port: ${{ secrets.PORT }}
          username: sp28337
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Копируем файлы в production (с sudo)
            sudo cp -r /home/sp28337/spa_build/dist/* /var/www/spa/dist/
            
            # Даём права доступа
            sudo chmod -R 755 /var/www/spa/dist
            sudo chown -R www-data:www-data /var/www/spa/dist
            
            # Перезагружаем nginx
            sudo systemctl reload nginx
            
            # Проверяем статус
            sudo systemctl status nginx
            
            # Очистка
            rm -rf /home/sp28337/spa_build/*
            
            echo "✅ Deployment successful!"
