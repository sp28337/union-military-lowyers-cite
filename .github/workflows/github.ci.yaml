name: Deploy SPA to Timeweb

on:
  push:
    branches:
      - main
      - dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð´ Ð¸Ð· Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ pnpm
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.10.0

      # 3. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Node.js 22.16.0
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.16.0'
          cache: 'pnpm'

      # 4. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ðŸ†• 5. Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ .env Ñ„Ð°Ð¹Ð» Ð¸Ð· GitHub Secrets
      - name: Create .env file
        run: |
          cat > .env << EOF
          EMAIL_USER=${{ secrets.EMAIL_USER }}
          VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}
          EOF
          echo "âœ… .env ÑÐ¾Ð·Ð´Ð°Ð½"

      # 6. Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚ (Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼Ð¸)
      - name: Build project
        run: pnpm build
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}

      # 7. Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ dist Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
      - name: Upload dist to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          port: ${{ secrets.PORT }}
          username: sp28337
          key: ${{ secrets.SSH_PRIVATE_KEY}}
          source: "dist/*"
          target: "/home/sp28337/spa_build/"
          rm: true

      # 8. Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
      - name: Deploy on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          port: ${{ secrets.PORT }}
          username: sp28337
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð² production (Ñ sudo)
            sudo cp -r /home/sp28337/spa_build/dist/* /var/www/spa/dist/
            
            # Ð”Ð°Ñ‘Ð¼ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
            sudo chmod -R 755 /var/www/spa/dist
            sudo chown -R www-data:www-data /var/www/spa/dist
            
            # ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ nginx
            sudo systemctl reload nginx
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
            sudo systemctl status nginx
            
            # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ°
            rm -rf /home/sp28337/spa_build/*
            
            echo "âœ… Deployment successful!"
